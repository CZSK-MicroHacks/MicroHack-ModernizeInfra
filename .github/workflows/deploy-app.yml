name: Build and Package Application

# This workflow builds the application and creates a GitHub Release
# The deploy job is optional and requires Azure credentials to be configured
# If Azure credentials are not set, the workflow will only build and create releases

on:
  push:
    branches:
      - main
    paths:
      - 'ModernizeInfraApp/**'
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  APP_PATH: './ModernizeInfraApp'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: Restore dependencies
      run: dotnet restore ${{ env.APP_PATH }}
    
    - name: Build application
      run: dotnet build ${{ env.APP_PATH }} --configuration Release --no-restore
    
    - name: Publish application
      run: dotnet publish ${{ env.APP_PATH }} --configuration Release --output ./publish --no-build
    
    - name: Create deployment package
      run: |
        cd publish
        zip -r ../app-binaries.zip .
        cd ..
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: app-binaries
        path: ./publish/
    
    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ github.run_number }}
        name: Build ${{ github.run_number }}
        body: |
          Automated build from commit ${{ github.sha }}
          
          **Commit Message:** ${{ github.event.head_commit.message }}
          
          **Deployment:**
          Download `app-binaries.zip` and deploy to VM using `update-application.ps1` script.
        files: app-binaries.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  deploy:
    needs: build
    runs-on: ubuntu-latest
    # Only run if Azure credentials are configured AND it's a push or manual trigger
    if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') && secrets.AZURE_CREDENTIALS != ''
    
    steps:
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Deploy to Azure VM
      run: |
        # Get VM details from secrets
        RESOURCE_GROUP="${{ secrets.AZURE_RESOURCE_GROUP }}"
        VM_NAME="${{ secrets.AZURE_VM_NAME }}"
        
        # Create PowerShell deployment script
        cat > deploy.ps1 << 'DEPLOY_SCRIPT'
        $ErrorActionPreference = "Stop"
        
        # Configuration
        $AppFolder = "C:\Apps\ModernizeInfraApp"
        $TempZip = "$env:TEMP\app-binaries-$((Get-Date).Ticks).zip"
        $BackupFolder = "C:\Apps\ModernizeInfraApp.backup.$(Get-Date -Format 'yyyyMMdd-HHmmss')"
        $ReleaseUrl = "https://github.com/CZSK-MicroHacks/MicroHack-ModernizeInfra/releases/download/build-${{ github.run_number }}/app-binaries.zip"
        
        Write-Host "=== Starting Deployment Process ===" -ForegroundColor Cyan
        Write-Host "Release URL: $ReleaseUrl" -ForegroundColor Yellow
        
        # Stop any running application
        Write-Host "Stopping application processes..." -ForegroundColor Yellow
        Get-Process -Name "dotnet" -ErrorAction SilentlyContinue | Where-Object { 
            $_.Path -like "*ModernizeInfraApp*"
        } | Stop-Process -Force -ErrorAction SilentlyContinue
        Start-Sleep -Seconds 2
        
        # Backup existing application
        if (Test-Path $AppFolder) {
            Write-Host "Backing up existing application to $BackupFolder..." -ForegroundColor Yellow
            Copy-Item -Path $AppFolder -Destination $BackupFolder -Recurse -Force -ErrorAction SilentlyContinue
        } else {
            Write-Host "Creating application folder..." -ForegroundColor Yellow
            New-Item -ItemType Directory -Path $AppFolder -Force | Out-Null
        }
        
        # Download application from GitHub release
        Write-Host "Downloading application from GitHub Release..." -ForegroundColor Yellow
        try {
            Invoke-WebRequest -Uri $ReleaseUrl -OutFile $TempZip -UseBasicParsing -ErrorAction Stop
            Write-Host "Download successful!" -ForegroundColor Green
        } catch {
            Write-Host "ERROR: Failed to download from releases: $_" -ForegroundColor Red
            Write-Host "Deployment failed!" -ForegroundColor Red
            exit 1
        }
        
        # Clear application folder
        Write-Host "Clearing application folder..." -ForegroundColor Yellow
        Get-ChildItem -Path $AppFolder -Exclude "*.backup*" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        
        # Extract application
        Write-Host "Extracting application..." -ForegroundColor Yellow
        Expand-Archive -Path $TempZip -DestinationPath $AppFolder -Force
        
        # Clean up
        Remove-Item -Path $TempZip -Force
        
        Write-Host "=== Deployment Completed Successfully ===" -ForegroundColor Green
        Write-Host ""
        Write-Host "Application deployed to: $AppFolder" -ForegroundColor Cyan
        Write-Host "To start the application, run:" -ForegroundColor Cyan
        Write-Host "  cd $AppFolder" -ForegroundColor White
        Write-Host "  dotnet ModernizeInfraApp.dll --urls http://0.0.0.0:8080" -ForegroundColor White
        DEPLOY_SCRIPT
        
        # Execute deployment script on VM
        echo "Executing deployment on VM: $VM_NAME in Resource Group: $RESOURCE_GROUP"
        az vm run-command invoke \
          --resource-group "$RESOURCE_GROUP" \
          --name "$VM_NAME" \
          --command-id RunPowerShellScript \
          --scripts @deploy.ps1
